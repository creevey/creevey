# TODO

<details>
<summary>Done</summary>

- [x] Test types
- [x] Add binary
- [x] Subscribe on workers ready
- [x] Parallel (need pre-build? worker-farm?)
  - [x] Custom server runner
  - [x] Patch mocha runner with cluster
- [x] Allow customize hooks to non-storybook env
- [x] Defined default config + deep merge
- [x] Build correct `d.ts` files. For now, you should remove require types from `lib/creevey.js` after build.
- [x] Pass `config` to server initialization (use process.cwd())
- [x] Single fork for single browser thread
- [x] Mocha workers for server
- [x] Add test parser
- [x] Selenium keep alive
- [x] Allow start/stop tests
- [x] reconnect to selenium (sending keep-alive)
- [x] subscribe websocket api (status commands)
- [x] websocket api types
- [x] Generate static page in report dir
- [x] Save/Load results in/from report dir (js/json)
- [x] Save images report in multiple runs
- [x] Not graceful exit master process on error in workers
- [x] Add worker timeout and restart it
- [x] ~~Ignore elements from screenshot~~
- [x] Custom mocha reporter for worker
- [x] Allow to use Teamcity reporter
- [x] Add worker ready event
- [x] Support load test files from glob patterns
- [x] Better handle websocket messages
- [x] Allow define sets (test files, address, browsers)
  - [x] Filter tests by path in parser
  - [x] Merge common config with browser config
- [x] Web interface
  - [x] webpack build
  - [x] usage react-ui
  - [x] output tests tree
  - [x] allow start/stop
  - [x] comm with API by test id
  - [x] approve images
  - [x] Offline mode, load report data
  - [x] Output test error message
  - [x] output reported images
  - [x] better images view like github does
    - [x] SlideView
    - [x] BlendView
  - [x] switch images by hotkeys
  - [x] output test status (pending)
  - [x] update/re-calc suite status
  - [x] use classnames (emotion)
  - [x] ApprovedRetry
  - [x] Fix incorrect output new images
  - [x] output skipped tests
  - [x] Output test error message
  - [x] Fit large images inside TestResultView
  - [x] Allow view fullscale images
  - [x] Invert expect/actual color
  - [x] Better output test error message
- [x] Test grep regexp don't work with parenthesis
- [x] Don't respect skip flag from report json
- [x] Browser resolution option
- [x] Fix TeamCity reporter `<unknown test name>`
- [x] Output images for Teamcity reporter
- [x] Setup viewport size
- [x] Color output in console
- [x] Server state sync
- [x] Config npmignore files
- [x] Status runner
- [x] Add Storybook for web ui components
- [x] Restart selenium driver on timeout
- [x] Export decorator from creevey
- [x] Improve ts support for creevey (like webpack does)
  - [x] Don't work with ts-node + esnext modules
- [x] Define simple version for browsers
- [x] Simplify types re-export for lib usage
- [x] Calc correct viewport size
- [x] Fix skip/unskip tests between run without delete report dir
- [x] Allow clean approved images
- [x] Generate runtime tests based on stories
- [x] Reload IE page on start (don't handle storybook hot-reload)
- [x] Allow leave reason comment for skipped tests
- [x] Update args readme (config, parser, ...)
- [x] Add cli arguments
  - [x] config
  - [x] parser
  - [x] ui
  - [x] reporter
  - [x] update
  - [x] ~~init~~
  - [x] port
- [x] Storybook integration
  - [x] Update to Storybook@5.x
  - [x] Reset mouse position
  - [x] Support storybook 3.x-5.x
  - [x] Simplify generated tests tree according by stories/tests/images
  - [x] Use require.context from storybook config or storybook event to get tests (without \_\_filename usage)
  - [x] Add note about skip option and story/kind name case convention
  - [x] Storybook support 5.3 declarative config https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#from-version-52x-to-53x
  - [x] Support stories name convention https://storybook.js.org/docs/formats/component-story-format/#storybook-export-vs-name-handling
  - [x] Framework agnostic decorator
  - [x] Add `didCatch` method to storybook decorator. Handle errors while switch stories
- [x] Allow Composite images
- [x] Slide story don't work correctly, must be fixed
- [x] Better error message about open storybook page
- [x] Exit if worker got `UnhandledPromiseRejectionWarning`
- [x] Serialize skip regexp
- [x] Husky, lint-staged
- [x] Rework UI
  - [x] Improve UI performance on initial load
  - [x] Put tests tree into side page
  - [x] Output test result view into main page block
  - [x] Output error message multiline
  - [x] Show icons for skipped tests
  - [x] Allow check/uncheck tests without results
  - [x] Add bottom padding into test tree
- [x] Update incorrect work with new structure directory
- [x] Reset button nowrap style
- [x] Skip by browser regexp don't work (webdriver serialization)
- [x] Convert storycase to export name
- [x] Allow assert multiple images in one test (chai toMatchImages())
- [x] Remove Loader, use require.context
- [x] Remove tests parser ability, support only storybook
- [x] ~~Add `babel-plugin-typescript-to-proptypes`~~ Seems this plugin doesn't do so much
- [x] Allow skip tests inside story
- [x] ~~Not properly work with CRA (need to install ts-node or @babel/register)~~ Add notes in readme
- [x] ~~Lint sort imports~~
- [x] ~~Allow define mocha hooks~~
- [x] Optimize stories load process (don't import other stuff like react, components and other browser libs/styles/images/fonts)
- [x] Don't output tests without status if filtering by status
- [x] Patch @babel/register hook to allow use '.ts' along side with '.tsx' extensions
- [x] HotReload tests files without restart
- [x] **has workaround** Can't use `By` and `Key` helpers from `selenium-webdriver` in tests, because webpack try to build bundle with `selenium-webdriver`
- [x] Chai used as deps, but in stories should imported explicitly. Add chai to peerdeps
- [x] Add description for types properties, like config/decorator/etc
- [x] Init pirates before any compiler (fix error with ts-node (allowJs: true) and pirates order)
- [x] Add `delay` option for stories. To allow wait some time before real test started (right after switch story)
- [x] Add composite screenshot helper (this.takeScreenshot should be composite)
- [x] Don't apply scrollbar hiding styles in composite images
- [x] Add authors
- [x] Handle error on mocha hooks
- [x] Bugs
  - [x] Reconnect on `WebDriverError: Session timed out or not found`
  - [x] On Teamcity cli exits with -1 code without any output

</details>

## First priority (v0.6)

- [x] Bugs
  - [x] Don't handle correctly storybook render story errors
  - [x] Readlink don't work on windows. Need to change storybook framework detection
  - [x] Restart workers output errors `NoSuchSessionError: Tried to run command without establishing a connection` and `TypeError: _cluster.default.disconnect is not a function`
- [x] Fix warnings
  - [x] Unexpected loaded state. Did you call `load` twice?
  - [x] [BABEL] Note: The code generator has deoptimised the styling of /home/kich/Projects/creevey/report/storybook/tmp-8207-HTp79b5JhpxQ-.js as it exceeds the max of 500KB.
  - [x] webpack-hot-middleware's client requires EventSource to work. You should include a polyfill if you want to support this browser: https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events#Tools
- [x] Cutoff subcomponents parameter
- [x] Apply AST transformation on storybook config directory (cut decorators)
- [x] EPIPE Error on SIGINT :(
- [x] Remove unnecessary deps and code, for example pirates, require.context, interpret, (?)other
- [x] Bugs
  - [x] In chrome 80 creevey sometime failed with error `MoveTargetOutOfBoundsError: move target out of bounds`
  - [x] For firefox composite images captured without scrollbars, but image width has scrollbar width
- [x] Optimize stories loading
  - [x] Add debug output on fail transformation
  - [x] Use proxy to handle side-effects
  - [x] AST transformation to exclude all source code except stories meta and tests (support only CSF)
- [x] Add examples
  - [x] Angular
  - [x] Create React App
- [ ] Docs
  - [ ] Add `delay` option
  - [x] Record screencast with Creevey UI
    - Pre-requirements: Storybook ui-kit + creevey setup + approve all images + vscode with opened story
    - Start storybook
    - Switch terminal tab
    - Start creevey --ui
    - Open `http://localhost:3000`
    - Run all tests
    - Open one of them
    - Open along side VSCode with that story
    - Change a little
    - Run that story again
    - Show failed test in different views
    - Approve image
  - [ ] Update Readme.md (also describe scenarios or how to capture screenshots)
    - badges
    - Title with short description
    - Logo or gif screen cast
    - How to start and what you get
    - How to setup selenium webdrivers locally (selenoid + docker)
    - How to write interaction tests for stories
    - Description about how creevey work
    - Describe creevey CLI
    - Describe creevey config options
    - Describe available storybook parameters
  - [ ] Update framework examples
  - [ ] Add topics in top of readme
    - How to Start (start storybook step)
    - Setup Selenium Grid
    - Write tests
    - Creevey under the hood
    - Configs/Options
      - CLI Options
      - creevey.config.ts
      - storybook parameters
    - Possible caveats
  - [x] Add instruction for various frameworks
    - [x] Angular
    - [x] Create React App
- [x] Storybook Integration
  - [x] Manually create ClientApi instance, if it doesn't exists
  - [x] ~~Support storybook configs with js extension (4.x and 5.2 versions)~~
- [x] ~~Allow define custom extensions to ignore it while story loading process~~

## Second priority (v0.7)

- [ ] Don't load any of addons
- [ ] Support mdx stories
- [ ] Update Eslint to v7
- [ ] Support run tests inside docker
- [ ] Setup NODE_ENV to 'test' on open storybook in browser
- [ ] Bugs
  - [ ] Error mocha instance already disposed in mocha@7.2
  - [ ] Fix taking composite screenshots with hided scrollbar
    - Take `document.documentElement.clientWidth/Height` instead of window rect
    - For each screenshot after scroll, take elementRect coordinates
    - Iterate be screen images and calculate resulting x/y coordinates for composite image
    - If image width/height greater than viewport width/height than scroll bar is captured
  - [ ] In multiple images tests output same test error for every image
- [ ] Features
  - [ ] Allow define custom localhost resolver in config
  - [ ] Add `only` option as opposite for `skip`
  - [ ] Allow to ignore elements in capturing screenshot
  - [ ] Allow set viewport sizes for story (use width x height as postfix for browser name in UI)
- [ ] Docs
  - [ ] Add fancy readme
  - [ ] Write about differences with other tools
  - [ ] Add how to start docker and IE11 especially
  - [ ] Add instruction for various frameworks
    - [ ] Create React App Typescript
    - [ ] Vue
- [ ] Add human readable error message if test failed with `window.__CREEVEY_SELECT_STORY__` is not a function

## Third priority (vNext)

- [ ] Drop storiesOf and Storybook v4.x support
  - [ ] Could we drop more entry points from webpack config? (generated entry for example)
- [ ] Creevey as Addon PoC
- [ ] Add Strobybook integration tests
- [ ] Transform to monorepo
  - [ ] `chai-images`
  - [ ] `creevey`
  - [ ] `creevey-selenium` (put gridUrl as option)
- [ ] Support other browser automation tools
  - [ ] Playwright
  - [ ] Puppeteer

## Not in first time

- [ ] Correctly reload and reset tests statuses according source code file dependencies
- [ ] Don't output skipped tests
- [ ] Improve css filter for blend view, try to reach pixelmatch output
- [ ] Profile tests loading process (maybe we don't need workers at all)
- [ ] Don't reset scroll on swap images
- [ ] Support config in ES Modules
- [ ] Always save images even if test with matchImages failed
- [ ] Add liftoff https://github.com/js-cli/js-liftoff
- [ ] Correctly resize images in views using correct proportions (smaller image should shrink if larger shrink too, max-width/max-height doesn't work)
- [ ] Tests on images view components with various scenarios (same/diff sizes, less/bigger viewport, elements with width/height not integer size)
- [ ] Write stories on new components
  - [x] SideBar
  - [ ] ResultPageHeader
- [ ] Bugs
  - [ ] Firefox double click if clicks in different tests
  - [ ] Mocha worker `Possible EventEmitter memory leak detected. 11 error listeners added`
- [ ] Improve CLI
  - [ ] Output cli help
  - [ ] Add grep/kind/story option
- [ ] Rework UI
  - [ ] Show removed tests results, mark these as removed
  - [ ] Allow hide skipped tests in UI
  - [ ] Allow switch between 1:1 and fit image views
- [ ] Add unit tests
- [ ] Github Actions
  - [x] Add linting job
  - [ ] Allow run ui tests in cli by `yarn test:ui`
- [ ] Storybook integration
  - [ ] Support stories separators https://storybook.js.org/docs/basics/writing-stories/#story-hierarchy
  - [ ] Support declarative 6.0 decorators format, like this https://github.com/storybookjs/storybook/tree/master/addons/knobs/src/preset
- [ ] Rewrite to use `worker_threads` instead of `cluster` to allow use shared memory
- [ ] Support mocha options for workers
- [ ] Programmic API
- [ ] Add logger lib

## Far future

- [ ] Storybook integration
  - [ ] Render tests UI as a part of storybook UI

## Maybe Never

- [ ] vscode mocha explorer
  - [ ] codelens run not work (need full path)
  - [ ] tests run with default timeout even if it changed in config
  - [ ] cwd and require conflict each other
  - [ ] mocha opts and mocha bin is not prefect support
- [ ] Use own runner instead of mocha
- [ ] Allow use creevey without storybook
- [ ] Support third-party test runners
